# Dynamic Bandwidth Monitor
# Leak detection method implemented in a real-time data historian
# Copyright (C) 2014-2020  J.H. Fiti√©, Vitens N.V.
#
# This file is part of DBM.
#
# DBM is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# DBM is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with DBM.  If not, see <http://www.gnu.org/licenses/>.

skip_tags: true

before_build:
  cmd: |-
    set PIHOME=%TEMP%
    mkdir "%PIHOME%\AF\PublicAssemblies\4.0"
    git show 635d59fdc8fb7f0de98d57b40ae83d5ebb37c683:OSIsoft.AFSDK.dll > "%PIHOME%\AF\PublicAssemblies\4.0\OSIsoft.AFSDK.dll"
    for /f "delims=" %%i in ('git rev-parse --short HEAD') do set commit=%%i
    powershell -Command "(Get-Content src\dbm\DBMInfo.vb) -replace 'Const GITHASH As String = \".*?\"', 'Const GITHASH As String = \"%commit%\"' | Set-Content src\dbm\DBMInfo.vb"

build_script:
  cmd: |-
    build.bat

after_build:
  cmd: |-
    set product=DBM
    for /f "delims=" %%i in ('powershell -Command "(Get-Item build\DBM.dll).VersionInfo.ProductVersion"') do set version=%%i
    for /f "delims=" %%i in ('powershell -Command "(Get-Item build\DBM.dll).VersionInfo.CompanyName"') do set company=%%i
    "%ProgramFiles(x86)%\Inno Setup 5\ISCC.exe" /O"%TEMP%" /FSetup_%product%_v%version%+%commit% /Q src\res\dbm.iss
    appveyor PushArtifact "%TEMP%\Setup_%product%_v%version%+%commit%.exe"

test_script:
  cmd: |-
    "%TEMP%\Setup_%product%_v%version%+%commit%.exe" /VERYSILENT /NORESTART
    "%ProgramFiles(x86)%\%company%\%product%\samples/runsamples.bat"
    powershell -Command "[int]!(Get-FileHash '%ProgramFiles(x86)%\%company%\%product%\samples/sample1.csv' -Algorithm MD5).Hash.ToLower().Equals('6cb141b48632e8ecabea8320886a6983')"
    powershell -Command "[int]!(Get-FileHash '%ProgramFiles(x86)%\%company%\%product%\samples/sample2.csv' -Algorithm MD5).Hash.ToLower().Equals('fc7b57bd245d877d1bb9c3098aba75de')"
    powershell -Command "[int]!(Get-FileHash '%ProgramFiles(x86)%\%company%\%product%\samples/sample3.csv' -Algorithm MD5).Hash.ToLower().Equals('32f98957d92a37c4d588535910cf003a')"
    powershell -Command "[int]!(Get-FileHash '%ProgramFiles(x86)%\%company%\%product%\samples/sample4.csv' -Algorithm MD5).Hash.ToLower().Equals('840bc8aa797b961c8764b43b788dbb03')"

deploy:
  tag: 'v$(version)+$(commit)'
  release: '$(product) v$(version)+$(commit)'
  description: '$(APPVEYOR_REPO_COMMIT_MESSAGE)'
  provider: GitHub
  auth_token:
    secure: BrTAHlG3kNuONUuCV7ZEqGZmiLwLr3bMDGexczO4xd+i8ZtVLUgMzBRMpEhdSzbK
  artifact: /.*/
  draft: false
  prerelease: false
  on:
    branch: master
