skip_tags: true

environment:
  certpw:
    secure: x1A3Bd0ABdiA1g53zAHzGg==

before_build:
  cmd: |-
    set PIHOME=%TEMP%
    mkdir "%PIHOME%\AF\PublicAssemblies\4.0"
    git show 635d59fdc8fb7f0de98d57b40ae83d5ebb37c683:OSIsoft.AFSDK.dll > "%PIHOME%\AF\PublicAssemblies\4.0\OSIsoft.AFSDK.dll"
    git show e6780c1a7ec7d1dbcdd6810266ecc4f953b6f901:vitensdev.pfx > "%TEMP%\vitensdev.pfx"
    for /f "delims=" %%i in ('git rev-parse --short HEAD') do set commit=%%i
    powershell -Command "(Get-Content src\dbm\DBMInfo.vb) -replace 'Const GITHASH As String = \".*?\"', 'Const GITHASH As String = \"%commit%\"' | Set-Content src\dbm\DBMInfo.vb"

build_script:
  cmd: |-
    build.bat

after_build:
  cmd: |-
    for %%f in (build\*.dll build\*.exe) do @sign.bat %%f "%TEMP%\vitensdev.pfx" %certpw%
    set product=DBM
    for /f "delims=" %%i in ('powershell -Command "(Get-Item build\DBM.dll).VersionInfo.ProductVersion"') do set version=%%i
    for /f "delims=" %%i in ('powershell -Command "(Get-Item build\DBM.dll).VersionInfo.CompanyName"') do set company=%%i
    "%ProgramFiles(x86)%\Inno Setup 5\ISCC.exe" /O"%TEMP%" /FSetup_%product%_v%version%+%commit% /Q src\res\dbm.iss
    sign.bat "%TEMP%\Setup_%product%_v%version%+%commit%.exe" "%TEMP%\vitensdev.pfx" %certpw%
    appveyor PushArtifact "%TEMP%\Setup_%product%_v%version%+%commit%.exe"

test_script:
  cmd: |-
    build\DBMAbout.exe | find "FAILED" > NUL && exit 1 || exit 0
    "%TEMP%\Setup_%product%_v%version%+%commit%.exe" /VERYSILENT /NORESTART
    if not exist "%ProgramFiles(x86)%\%company%\%product%\build\DBM.dll" exit 1

deploy:
  tag: 'v$(version)+$(commit)'
  release: '$(product) v$(version)+$(commit)'
  description: '$(APPVEYOR_REPO_COMMIT_MESSAGE)'
  provider: GitHub
  auth_token:
    secure: BrTAHlG3kNuONUuCV7ZEqGZmiLwLr3bMDGexczO4xd+i8ZtVLUgMzBRMpEhdSzbK
  artifact: /.*/
  draft: false
  prerelease: false
  on:
    branch: master
